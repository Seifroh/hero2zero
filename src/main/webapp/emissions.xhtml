<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">

    <h:head>
        <meta charset="UTF-8"/>
        <title>Like Hero to Zero | CO₂-Emissionen</title>
        <h:outputStylesheet library="primefaces-nova-light" name="theme.css"/>
    </h:head>
    <h:body>
        <p:toolbar >
            <p:toolbarGroup align="left" style="display:flex; align-items:center; gap:0.5rem">
                <h:graphicImage library="images"
                                name="logo.png"
                                alt="Hero2Zero Logo"
                                height="80"/>
                <h1>Like Hero to Zero</h1>
            </p:toolbarGroup>

            <p:toolbarGroup align="right" style="display:flex; align-items:center; gap:0.5rem">
                <h:panelGroup rendered="#{!loginBean.loggedIn}">
                    <p:button value="Login"
                              icon="pi pi-sign-in"
                              outcome="/admin/emissions-edit.xhtml"
                              styleClass="ui-button-sm"/>
                </h:panelGroup>

                <h:panelGroup rendered="#{loginBean.loggedIn}">
                    <p:button value="Datenpflege"
                              icon="pi pi-database"
                              outcome="/admin/emissions-edit.xhtml"
                              styleClass="ui-button-sm"/>

                    <h:form prependId="false" style="display:inline">
                        <p:commandButton value="Logout"
                                         icon="pi pi-sign-out"
                                         action="#{loginBean.logout()}"
                                         ajax="false"
                                         styleClass="ui-button-sm"/>
                    </h:form>
                </h:panelGroup>

                <p:button value="Home"
                          icon="pi pi-home"
                          outcome="/emissions.xhtml"
                          styleClass="ui-button-sm"/>

                <p:button value="Impressum"
                          icon="pi pi-info-circle"
                          onclick="PF('impressumDlg').show();return false;"
                          styleClass="ui-button-sm"/>
            </p:toolbarGroup>
        </p:toolbar>

        <h:panelGroup rendered="#{loginBean.loggedIn}" 
                      layout="block"
                      style="text-align:right; padding:0 1em 0.5em 1em;">
            <h:outputText value="Angemeldet als #{facesContext.externalContext.userPrincipal.name}" 
                          style="font-style:italic;"/>
        </h:panelGroup>

        <p:dialog header="Hinweis" widgetVar="impressumDlg"
                  modal="true" closable="true"
                  draggable="false" resizable="false">
            <h:outputText value="Uniprojekt – kein formelles Impressum notwendig."/>
        </p:dialog>
        <p:dialog header="Bitte Staatsbürgerschaft wählen"
                  widgetVar="citizenDlg"
                  modal="true" closable="false" resizable="false"
                  visible="#{emissionBean.showCitizenshipDialog}">
            <h:form id="citizenForm">
                <h:outputLabel for="cit" value="Land"/>
                <p:selectOneMenu id="cit"
                                 value="#{emissionBean.selectedCountry}"
                                 required="true">
                    <f:selectItem itemLabel="Bitte wählen ..." itemValue=""/>
                    <f:selectItems value="#{emissionBean.countryOptions}"/>
                </p:selectOneMenu>

                <!-- JA: Staatsbürgerschaft setzen -->
                <p:commandButton value="Übernehmen"
                                 action="#{emissionBean.applyCitizenship}"
                                 update=":emissionsForm"
                                 resetValues="true"
                                 oncomplete="PF('citizenDlg').hide()"/>

                <!-- NEIN: Alle Länder laden -->
                <p:commandButton value="Alle Länder anzeigen"
                                 action="#{emissionBean.ladeAlle}"
                                 process="@this"
                                 immediate="true"
                                 update=":emissionsForm"
                                 resetValues="true"
                                 oncomplete="PF('citizenDlg').hide()"/>
            </h:form>
        </p:dialog>

        <h:form id="emissionsForm">
            <p:growl id="messages" showDetail="true" showSummary="false"/>

            <h:panelGroup layout="block">
                <p>
                    Über die Filterfelder in der Tabelle können Sie gezielt nach Ländern, Ländercodes, Jahren oder CO₂ Werten suchen.<br/>
                    Nachkommastellen bitte mit Punkt eingeben. Beispiel 0.1.<br/>
                    Diese Seite ist ein Prototyp. Texte sind auf deutsch. Tabelleninhalte und Zahlenformate sind englisch.
                </p>
            </h:panelGroup>

            <h:panelGroup rendered="#{not empty emissionBean.vorauswahlHinweis}"
                          layout="block"
                          style="margin:1em 0">
                <h:outputText value="#{emissionBean.vorauswahlHinweis}"/>
            </h:panelGroup>

            <p:accordionPanel multiple="false" activeIndex="-1" style="margin:1em 0">
                <p:tab title="Alle verfügbaren Länder">
                    <p:inputTextarea id="allCountries"
                                     value="#{emissionBean.countryListText}"
                                     readonly="true"
                                     rows="5"
                                     style="width:100%"/>
                </p:tab>
            </p:accordionPanel>

            <p:commandButton value="Alle Daten"
                             icon="pi pi-globe"
                             action="#{emissionBean.ladeAlle}"
                             update="@form dataTable"                
                             oncomplete="PF('dataTable').clearFilters();"/>

            <p:dataTable id="dataTable"
                         widgetVar="dataTable"
                         value="#{emissionBean.allEmissionsApproved}"
                         var="e"
                         paginator="true" rows="15"
                         filterEvent="keyup" filterDelay="200"
                         currentPageReportTemplate="Einträge gesamt: {totalRecords}"
                         styleClass="p-datatable-sm"
                         style="width:100%;"
                         paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
                         emptyMessage="Keine Einträge gefunden.">

                <p:column headerText="Land"
                          filterBy="#{e.country}"
                          filterMatchMode="contains"
                          style="width:25%">
                    <f:facet name="filter">
                        <p:inputText value="#{emissionBean.selectedCountry}"
                                     placeholder="Land"
                                     style="width:100%"
                                     maxlength="50"
                                     onkeyup="if (this.checkValidity()) {
                                                 PF('dataTable').filter();
                                             } else {
                                                 this.reportValidity();
                                             }"
                                     pt:pattern="[A-Za-zÄÖÜäöüß ]+"
                                     pt:title="Nur Buchstaben erlaubt, auch Umlaute. Maximal 50 Zeichen."/>
                    </f:facet>
                    #{e.country}
                </p:column>

                <p:column headerText="Code"
                          filterBy="#{e.countryCode}"
                          filterMatchMode="contains"
                          style="width:25%">

                    <f:facet name="filter">
                        <p:inputText 
                            style="width:100%"
                            placeholder="Code"
                            maxlength="3"
                            onkeyup="if (this.checkValidity()) {
                                        PF('dataTable').filter();
                                    } else {
                                        this.reportValidity();
                                    }"
                            pt:pattern="[A-Za-z]{1,3}"
                            pt:title="Bis zu 3 Buchstaben. Keine Umlaute erlaubt."/>
                    </f:facet>
                    #{e.countryCode}
                </p:column>

                <p:column headerText="Jahr"
                          filterBy="#{e.year}"
                          filterMatchMode="equals"
                          style="width:25%">
                    <f:facet name="filter">
                        <p:inputText value="#{emissionBean.selectedYear}" 
                                     placeholder="Jahr"
                                     style="width:100%"
                                     maxlength="4"
                                     onkeyup="if (this.checkValidity()) {
                                                 PF('dataTable').filter();
                                             } else {
                                                 this.reportValidity();
                                             }"
                                     pt:pattern="\d{4}"
                                     pt:title="Vier Zahlen erforderlich, z.B. 1950."/>
                    </f:facet>
                    #{e.year}
                </p:column>

                <p:column headerText="CO₂ (kt)"
                          filterBy="#{e.co2Emissions}"
                          filterFunction="#{emissionBean.co2Filter}"
                          style="width:15%">
                    <f:facet name="filter">
                        <p:inputText placeholder="CO₂"
                                     maxlength="12"
                                     style="width:100%"
                                     onkeyup="PF('dataTable').filter()"
                                     pt:pattern="\d+(\.\d+)?"
                                     pt:title="Nur Zahlen erlaubt. Nachkommastellen bitte mit Punkt schreiben (z.B. 0.1). Maximal 12 Zeichen."/>
                    </f:facet>
                    #{e.co2Emissions}
                </p:column>

            </p:dataTable>
        </h:form>
        <footer>
            Modul: IPWA02-01 Programmierung von industriellen Informationssystemen mit Java EE
        </footer>
    </h:body>
</html>