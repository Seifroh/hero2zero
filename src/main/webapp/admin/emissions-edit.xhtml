<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">

    <h:head>
        <meta charset="UTF-8"/>
        <title>Like Hero to Zero | Wissenschaftler</title>
        <h:outputStylesheet library="primefaces-nova-light" name="theme.css"/>
    </h:head>
    <h:body>
        <p:toolbar style="background-color:#f7f2e8; padding:0.5em;">
            <p:toolbarGroup align="left" style="display:flex; align-items:center; gap:0.5em;">
                <h:graphicImage library="images"
                                name="logo.png"
                                alt="Hero2Zero Logo"
                                height="80"/>
                <h:outputText value="Like Hero to Zero - Wissenschaftsbereich"
                              style="font-weight:bold; font-size:1.7em; color:#333; "/>
            </p:toolbarGroup>

            <p:toolbarGroup align="right" style="display:flex; flex-wrap:wrap; align-items:center; justify-content:flex-end; gap:0.5em">
                <h:panelGroup rendered="#{!loginBean.loggedIn}">
                    <p:button value="Login"
                              icon="pi pi-sign-in"
                              outcome="login"
                              styleClass="ui-button-sm"/>
                </h:panelGroup>
                <h:panelGroup rendered="#{loginBean.loggedIn}">
                    <!-- Datenpflege-Button bleibt auskommentiert für spätere Nutzung -->
                    <!--
                    <p:button value="Datenpflege"
                              icon="pi pi-database"
                              outcome="/admin/emissions-edit.xhtml"
                              styleClass="ui-button-sm"/>
                    -->
                    <h:form prependId="false" style="display:inline;">
                        <p:commandButton value="Logout"
                                         icon="pi pi-sign-out"
                                         action="#{loginBean.logout()}"
                                         ajax="false"
                                         styleClass="ui-button-sm"/>
                    </h:form>
                </h:panelGroup>
                <p:button value="Home"
                          icon="pi pi-home"
                          outcome="/emissions.xhtml"
                          styleClass="ui-button-sm"/>
                <p:button value="Impressum"
                          icon="pi pi-info-circle"
                          onclick="PF('impressumDlg').show();return false;"
                          styleClass="ui-button-sm"/>
            </p:toolbarGroup>
        </p:toolbar>

        <!-- Loginstatus unterhalb -->
        <h:panelGroup rendered="#{loginBean.loggedIn}" layout="block"
                      style="text-align:right; padding:0 1em 0.5em 1em;">
            <h:outputText value="Angemeldet als #{facesContext.externalContext.userPrincipal.name}"
                          style="color:#333; font-style:italic;"/>
        </h:panelGroup>

        <!-- Impressum-Dialog global -->
        <p:dialog header="Hinweis" widgetVar="impressumDlg"
                  modal="true" closable="true"
                  draggable="false" resizable="false">
            <h:outputText value="Uniprojekt – keine kommerzielle Nutzung."/>
        </p:dialog>

        <h:form id="adminForm">

            <!-- Growl für Meldungen -->
            <p:growl id="messages" showDetail="true" showSummary="false" life="5000"/>

            <!-- Toolbar mit "Neue Emission" und ggf. späterem "Admin"-Button -->
            <p:toolbar style="margin-bottom:1em">
                <p:toolbarGroup>
                    <p:commandButton id="btnNew"
                                     value="Neue Emission"
                                     icon="pi pi-plus"
                                     styleClass="ui-button-sm"
                                     oncomplete="PF('dlgNewEmission').show()"
                                     process="@this"
                                     update="@form:messages"/>
                </p:toolbarGroup>
                <!-- Beispiel für späteren Admin-Button:
                <p:toolbarGroup align="right">
                    <p:commandButton id="btnAdmin"
                                     value="Admin"
                                     icon="pi pi-user"
                                     styleClass="ui-button-sm"
                                     action="#{emissionsAdminBean.goAdmin}"
                                     update=":adminForm:dataTable :adminForm:messages"/>
                </p:toolbarGroup>
                -->
            </p:toolbar>

            <!-- Editable DataTable -->
            <p:dataTable id="dataTable"
                         widgetVar="adminTable"
                         value="#{emissionsAdminBean.allEmissions}"
                         var="e"
                         editable="true" editMode="cell"
                         paginator="true" rows="15"
                         filterEvent="keyup" filterDelay="200"
                         style="width:100%">

                <p:column headerText="ID" style="width:8%">
                    <h:outputText value="#{e.id}"/>
                </p:column>

                <p:column headerText="Land" style="width:20%"
                          filterBy="#{e.country}" filterMatchMode="contains">
                    <f:facet name="filter">
                        <p:inputText id="filterCountry"
                                     placeholder="Land"
                                     style="width:100%"
                                     maxlength="50"
                                     pt:pattern="[A-Za-zÄÖÜäöüß ]+"
                                     pt:title="Nur Buchstaben. Maximal 50 Zeichen."
                                     onkeyup="PF('adminTable').filter()"/>
                    </f:facet>
                    <h:outputText value="#{e.country}"/>
                </p:column>

                <p:column headerText="Code" style="width:12%"
                          filterBy="#{e.countryCode}" filterMatchMode="contains">

                    <f:facet name="filter">
                        <p:inputText id="filterCode"
                                     placeholder="Code"
                                     style="width:100%"
                                     maxlength="3"
                                     pt:pattern="[A-Za-z]{1,3}"
                                     pt:title="Bis zu 3 Buchstaben. Keine Umlaute."
                                     onkeyup="PF('adminTable').filter()"/>
                    </f:facet>
                    <h:outputText value="#{e.countryCode}"/>
                </p:column>

                <p:column headerText="Jahr" style="width:12%"
                          filterBy="#{e.year}" filterMatchMode="equals">
                    <f:facet name="filter">
                        <p:inputText id="filterYear"
                                     placeholder="Jahr"
                                     style="width:100%"
                                     maxlength="4"
                                     pt:pattern="\d{4}"
                                     pt:title="4 Ziffern, z. B. 1950."
                                     onkeyup="PF('adminTable').filter()"/>
                    </f:facet>
                    <h:outputText value="#{e.year}"/>
                </p:column>

                <p:column headerText="CO₂ (kt)" style="width:15%"
                          filterBy="#{e.co2Emissions}"
                          filterFunction="#{filterUtil.co2Filter}">

                    <f:facet name="filter">
                        <p:inputText id="filterCo2"
                                     placeholder="CO₂"
                                     style="width:100%"
                                     maxlength="10"
                                     pt:pattern="\d+(\.\d+)?"
                                     pt:title="Nur Zahlen. Nachkommastellen mit Punkt."
                                     onkeyup="PF('adminTable').filter()"/>
                    </f:facet>
                    <p:rowEditor />
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{e.co2Emissions}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText value="#{e.co2Emissions}"
                                         style="width:100%"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <!-- Freigabe -->
                <p:column headerText="Freigabe" style="width:10%">
                    <h:panelGroup>
                        <h:outputText value="Ja" rendered="#{e.approved}"/>
                        <p:commandButton id="btnApprove"
                                         value="Freigeben"
                                         icon="pi pi-check"
                                         styleClass="ui-button-sm"
                                         action="#{emissionsAdminBean.approve(e)}"
                                         update=":adminForm:dataTable :adminForm:messages"
                                         rendered="#{!e.approved}"/>
                    </h:panelGroup>
                </p:column>

                <p:column headerText="Change-Log" style="width:25%">
                    <h:outputText value="#{e.changeLog}"/>
                </p:column>

                <!-- Ajax-Listener für Cell-Edit -->
                <p:ajax event="cellEdit"
                        listener="#{emissionsAdminBean.onCellEdit}"
                        update=":adminForm:dataTable :adminForm:messages"/>
            </p:dataTable>

            <!-- Dialog zur Anlage einer neuen Emission -->
            <p:dialog id="dlgNewEmission"
                      header="Neue Emission anlegen"
                      widgetVar="dlgNewEmission"
                      modal="true"
                      closable="true"
                      resizable="false">

                <h:panelGrid id="gridNew" columns="2" cellpadding="5">
                    <h:outputLabel for="countrySelect" value="Land:"/>
                    <p:selectOneMenu id="countrySelect"
                                     value="#{emissionsAdminBean.newEmission.countryCode}"
                                     required="true"
                                     style="width:100%">
                        <f:selectItem itemLabel="Bitte wählen ..." itemValue="" noSelectionOption="true"/>
                        <f:selectItems value="#{emissionsAdminBean.availableCountries}"
                                       var="c"
                                       itemLabel="#{c.country} (#{c.countryCode})"
                                       itemValue="#{c.countryCode}"/>
                    </p:selectOneMenu>

                    <h:outputLabel for="inYear" value="Jahr:"/>
                    <p:inputText id="inYear"
                                 value="#{emissionsAdminBean.newEmission.year}"
                                 required="true"
                                 maxlength="4"
                                 label="Jahr"/>

                    <h:outputLabel for="inCo2" value="CO₂ (kt):"/>
                    <p:inputText id="inCo2"
                                 value="#{emissionsAdminBean.newEmission.co2Emissions}"
                                 label="CO₂"/>
                </h:panelGrid>

                <p:commandButton value="Speichern"
                                 icon="pi pi-save"
                                 styleClass="ui-button-primary"
                                 process="@form"
                                 action="#{emissionsAdminBean.saveNew}"
                                 update=":adminForm:dataTable :adminForm:messages"
                                 oncomplete="PF('dlgNewEmission').hide()"/>
            </p:dialog>
        </h:form>
    </h:body>
</html>
