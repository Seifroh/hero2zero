<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">

    <h:head>
        <meta charset="UTF-8"/>
        <title>Like Hero to Zero | Wissenschaftler</title>
        <h:outputStylesheet library="nova-light" name="theme.css"/>
    </h:head>
    <h:body>
        <p:toolbar style="background-color:#f7f2e8; padding:0.5em;">
            <p:toolbarGroup align="left" style="display:flex; align-items:center; gap:0.5em">
                <h:graphicImage library="images"
                                name="logo.png"
                                alt="Hero2Zero Logo"
                                height="80"/>
                <h:outputText value="Like Hero to Zero"
                              style="font-weight:bold; font-size:1.5em; color:#333"/>
            </p:toolbarGroup>

            <p:toolbarGroup align="right" style="display:flex; flex-wrap:wrap; align-items:center; justify-content:flex-end; gap:0.5em">

                <h:panelGroup rendered="#{!loginBean.loggedIn}">
                    <p:button value="Login"
                              icon="pi pi-sign-in"
                              outcome="login"
                              styleClass="ui-button-sm"/>
                </h:panelGroup>

                <h:panelGroup rendered="#{loginBean.loggedIn}">
                    <!--<p:button value="Datenpflege"
                              icon="pi pi-database"
                              outcome="/admin/emissions-edit.xhtml"
                              styleClass="ui-button-sm"/>-->

                    <h:form prependId="false" style="display:inline">
                        <p:commandButton value="Logout"
                                         icon="pi pi-sign-out"
                                         action="#{loginBean.logout()}"
                                         ajax="false"
                                         styleClass="ui-button-sm"/>
                    </h:form>
                </h:panelGroup>

                <p:button value="Home"
                          icon="pi pi-home"
                          outcome="/emissions.xhtml"
                          styleClass="ui-button-sm"/>

                <p:button value="Impressum"
                          icon="pi pi-info-circle"
                          onclick="PF('impressumDlg').show();return false;"
                          styleClass="ui-button-sm"/>
            </p:toolbarGroup>
        </p:toolbar>

        <!-- Loginstatus unterhalb -->
        <h:panelGroup rendered="#{loginBean.loggedIn}" layout="block"
                      style="text-align:right; padding:0 1em 0.5em 1em;">
            <h:outputText value="Angemeldet als #{facesContext.externalContext.userPrincipal.name}"
                          style="color:#333; font-style:italic;"/>
        </h:panelGroup>

        <!-- Impressum-Dialog global -->
        <p:dialog header="Hinweis" widgetVar="impressumDlg"
                  modal="true" closable="true"
                  draggable="false" resizable="false">
            <h:outputText value="Uniprojekt – kein formelles Impressum notwendig."/>
        </p:dialog>

        <h:form id="adminForm">

            <p:growl id="messages" showDetail="true" showSummary="false"/>

            <h:panelGroup layout="block" style="margin-bottom:1em">
                <p:commandButton value="Neuer Eintrag"
                                 icon="pi pi-plus"
                                 oncomplete="PF('newDlg').show()"
                                 process="@this"
                                 styleClass="ui-button-sm"/>
            </h:panelGroup>

            <p:dataTable id="dataTable"
                         widgetVar="adminTable"
                         value="#{emissionsAdminBean.allEmissions}"
                         var="e"
                         editable="true" editMode="cell"
                         paginator="true" rows="15"
                         filterEvent="keyup" filterDelay="200"
                         style="width:100%">

                <p:column headerText="ID" style="width:10%">
                    #{e.id}
                </p:column>

                <p:column headerText="Land"
                          filterBy="#{e.country}"
                          filterMatchMode="contains"
                          style="width:20%">
                    <f:facet name="filter">
                        <p:inputText placeholder="Land"
                                     style="width:100%"
                                     maxlength="50"
                                     pt:pattern="[A-Za-zÄÖÜäöüß ]+"
                                     pt:title="Nur Buchstaben erlaubt. Maximal 50 Zeichen."
                                     onkeyup="PF('adminTable').filter()"/>
                    </f:facet>
                    #{e.country}
                </p:column>

                <p:column headerText="Code"
                          filterBy="#{e.countryCode}"
                          filterMatchMode="contains"
                          style="width:15%">
                    <f:facet name="filter">
                        <p:inputText placeholder="Code"
                                     style="width:100%"
                                     maxlength="3"
                                     pt:pattern="[A-Za-z]{1,3}"
                                     pt:title="Bis zu 3 Buchstaben. Keine Umlaute erlaubt."
                                     onkeyup="PF('adminTable').filter()"/>
                    </f:facet>
                    #{e.countryCode}
                </p:column>

                <p:column headerText="Jahr"
                          filterBy="#{e.year}"
                          filterMatchMode="equals"
                          style="width:15%">
                    <f:facet name="filter">
                        <p:inputText placeholder="Jahr"
                                     style="width:100%"
                                     maxlength="4"
                                     pt:pattern="\d{4}"
                                     pt:title="Vier Zahlen erforderlich, z. B. 1950."
                                     onkeyup="PF('adminTable').filter()"/>
                    </f:facet>
                    #{e.year}
                </p:column>

                <p:column headerText="CO₂ (kt)"
                          filterBy="#{e.co2Emissions}"
                          filterFunction="#{filterUtil.co2Filter}"
                          style="width:15%">
                    <f:facet name="filter">
                        <p:inputText placeholder="CO₂"
                                     style="width:100%"
                                     maxlength="10"
                                     pt:pattern="\d+(\.\d+)?"
                                     pt:title="Nur Zahlen erlaubt. Nachkommastellen bitte mit Punkt schreiben (z. B. 0.1)."
                                     onkeyup="PF('adminTable').filter()"/>
                    </f:facet>
                    <p:cellEditor>
                        <f:facet name="output">#{e.co2Emissions}</f:facet>
                        <f:facet name="input">
                            <p:inputText value="#{e.co2Emissions}" style="width:100%"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:ajax event="cellEdit"
                        listener="#{emissionsAdminBean.onCellEdit}"
                        update=":adminForm:messages"/>

                <p:column headerText="Freigabe" style="width:15%">
                    <h:panelGroup>
                        <h:outputText value="Ja" rendered="#{e.approved}"/>
                        <p:commandButton value="Freigeben"
                                         icon="pi pi-check"
                                         action="#{emissionsAdminBean.approve(e)}"
                                         update=":adminForm:dataTable :adminForm:messages"
                                         rendered="#{!e.approved}"
                                         styleClass="ui-button-sm"/>
                    </h:panelGroup>
                </p:column>
            </p:dataTable>
            <!-- Der Dialog zum Neuanlegen -->
            <p:dialog header="Neue Emission"
                      widgetVar="newDlg"
                      modal="true"
                      closable="true"
                      resizable="false">
                <h:panelGrid columns="2" cellpadding="5">
                    <h:outputLabel for="country" value="Land:"/>
                    <p:inputText id="country"
                                 value="#{emissionsAdminBean.newEmission.country}"
                                 required="true"/>

                    <h:outputLabel for="code" value="Code:"/>
                    <p:inputText id="code"
                                 value="#{emissionsAdminBean.newEmission.countryCode}"
                                 required="true"/>

                    <h:outputLabel for="year" value="Jahr:"/>
                    <p:inputText id="year"
                                 value="#{emissionsAdminBean.newEmission.year}"
                                 required="true"
                                 maxlength="4"/>

                    <h:outputLabel for="co2" value="CO₂ (kt):"/>
                    <p:inputText id="co2"
                                 value="#{emissionsAdminBean.newEmission.co2Emissions}"/>
                </h:panelGrid>

                <p:commandButton value="Speichern"
                                 action="#{emissionsAdminBean.saveNew}"
                                 process="@form"
                                 update=":adminForm:dataTable :adminForm:messages"
                                 oncomplete="PF('newDlg').hide()"/>
            </p:dialog>
        </h:form>
    </h:body>
</html>
