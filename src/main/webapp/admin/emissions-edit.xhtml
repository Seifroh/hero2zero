<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">

    <h:head>
        <meta charset="UTF-8"/>
        <title>Like Hero to Zero | Wissenschaftler</title>
        <h:outputStylesheet library="primefaces-nova-light" name="theme.css"/>
    </h:head>
    <h:body>
        <p:toolbar style="background-color:#f7f2e8; padding:0.5em;">
            <p:toolbarGroup align="left" style="display:flex; align-items:center; gap:0.5em;">
                <h:graphicImage library="images"
                                name="logo.png"
                                alt="Hero2Zero Logo"
                                height="80"/>
                <h:outputText value="Like Hero to Zero - Wissenschaftsbereich"
                              style="font-weight:bold; font-size:1.7em; color:#333; "/>
            </p:toolbarGroup>

            <p:toolbarGroup align="right" style="display:flex; flex-wrap:wrap; align-items:center; justify-content:flex-end; gap:0.5em">
                <h:panelGroup rendered="#{!loginBean.loggedIn}">
                    <p:button value="Login"
                              icon="pi pi-sign-in"
                              outcome="login"
                              styleClass="ui-button-sm"/>
                </h:panelGroup>
                <h:panelGroup rendered="#{loginBean.loggedIn}">
                    <!-- Datenpflege-Button bleibt auskommentiert für spätere Nutzung -->
                    <!--
                    <p:button value="Datenpflege"
                              icon="pi pi-database"
                              outcome="/admin/emissions-edit.xhtml"
                              styleClass="ui-button-sm"/>
                    -->
                    <h:form style="display:inline;">
                        <p:commandButton value="Logout"
                                         icon="pi pi-sign-out"
                                         action="#{loginBean.logout()}"
                                         ajax="false"
                                         styleClass="ui-button-sm"/>
                    </h:form>
                </h:panelGroup>
                <p:button value="Home"
                          icon="pi pi-home"
                          outcome="/emissions.xhtml"
                          styleClass="ui-button-sm"/>
                <p:button value="Impressum"
                          icon="pi pi-info-circle"
                          onclick="PF('impressumDlg').show();return false;"
                          styleClass="ui-button-sm"/>
            </p:toolbarGroup>
        </p:toolbar>

        <!-- Loginstatus unterhalb -->
        <h:panelGroup rendered="#{loginBean.loggedIn}" layout="block"
                      style="text-align:right; padding:0 1em 0.5em 1em;">
            <h:outputText value="Angemeldet als #{facesContext.externalContext.userPrincipal.name}"
                          style="color:#333; font-style:italic;"/>
        </h:panelGroup>

        <!-- Impressum-Dialog global -->
        <p:dialog header="Hinweis" widgetVar="impressumDlg"
                  modal="true" closable="true"
                  draggable="false" resizable="false">
            <h:outputText value="Uniprojekt – keine kommerzielle Nutzung."/>
        </p:dialog>

        <p:accordionPanel multiple="false" activeIndex="-1" style="margin-bottom:1em">
            <p:tab title="Zur Freigabe (#{emissionsAdminBean.pendingEmissions.size()})">
                <p:dataTable value="#{emissionsAdminBean.pendingEmissions}"
                             var="p" rows="5" paginator="true"
                             style="width:100%">
                    <p:column headerText="ID">
                        <h:outputText value="#{p.id}" />
                    </p:column>
                    <p:column headerText="Land">
                        <h:outputText value="#{p.country}" />
                    </p:column>
                    <p:column headerText="Jahr">
                        <h:outputText value="#{p.year}" />
                    </p:column>
                    <p:column headerText="Änderung">
                        <h:outputText value="#{p.changeLog}" />
                    </p:column>
                </p:dataTable>
            </p:tab>
        </p:accordionPanel>

        <h:form id="adminForm">
            <p:growl id="messages" showDetail="true" showSummary="false" life="5000"/>

            <p:toolbar style="margin-bottom:1em">
                <p:toolbarGroup>
                    <p:commandButton id="btnNew"
                                     value="Neue Emission"
                                     icon="pi pi-plus"
                                     styleClass="ui-button-sm"
                                     oncomplete="PF('dlgNewEmission').show()"
                                     process="@this"
                                     update="@form:messages"/>
                </p:toolbarGroup>
            </p:toolbar>

            <!-- DataTable für Admin & Wissenschaftler -->
            <p:dataTable id="dataTable"
                         widgetVar="adminTable"
                         value="#{emissionsAdminBean.allEmissions}"
                         var="e"
                         editable="true" editMode="cell"
                         paginator="true" rows="10"
                         filterEvent="keyup" filterDelay="200"
                         style="width:100%">

                <p:column headerText="ID" 
                          style="width:7%">
                    <h:outputText value="#{e.id}"/>
                </p:column>

                <p:column headerText="Land" 
                          style="width:20%"
                          filterBy="#{e.country}" 
                          filterMatchMode="contains">
                    <f:facet name="filter">
                        <p:inputText id="filterCountry"
                                     placeholder="Land"
                                     style="width:100%"
                                     maxlength="50"
                                     pt:pattern="[A-Za-zÄÖÜäöüß ]+"
                                     pt:title="Nur Buchstaben. Maximal 50 Zeichen."
                                     onkeyup="PF('adminTable').filter()"/>
                    </f:facet>
                    <h:outputText value="#{e.country}"/>
                </p:column>

                <p:column headerText="Code" 
                          style="width:10%"
                          filterBy="#{e.countryCode}" 
                          filterMatchMode="contains">

                    <f:facet name="filter">
                        <p:inputText id="filterCode"
                                     placeholder="Code"
                                     style="width:100%"
                                     maxlength="3"
                                     pt:pattern="[A-Za-z]{1,3}"
                                     pt:title="Bis zu 3 Buchstaben. Keine Umlaute."
                                     onkeyup="PF('adminTable').filter()"/>
                    </f:facet>
                    <h:outputText value="#{e.countryCode}"/>
                </p:column>

                <p:column headerText="Jahr" style="width:10%"
                          filterBy="#{e.year}" filterMatchMode="equals">
                    <f:facet name="filter">
                        <p:inputText id="filterYear"
                                     placeholder="Jahr"
                                     style="width:100%"
                                     maxlength="4"
                                     pt:pattern="\d{4}"
                                     pt:title="4 Ziffern, z. B. 1950."
                                     onkeyup="PF('adminTable').filter()"/>
                    </f:facet>
                    <h:outputText value="#{e.year}"/>
                </p:column>

                <p:column headerText="CO₂ (kt)" style="width:12%"
                          filterBy="#{e.co2Emissions}"
                          filterFunction="#{filterUtil.co2Filter}">

                    <f:facet name="filter">
                        <p:inputText id="filterCo2"
                                     placeholder="CO₂"
                                     style="width:100%"
                                     maxlength="10"
                                     pt:pattern="\d+(\.\d+)?"
                                     pt:title="Nur Zahlen. Nachkommastellen mit Punkt."
                                     onkeyup="PF('adminTable').filter()"/>
                    </f:facet>
                    <p:rowEditor />
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{e.co2Emissions}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText value="#{e.co2Emissions}"
                                         style="width:100%"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column headerText="Freigabe" style="width:11%" rendered="#{facesContext.externalContext.isUserInRole('admin')}">
                    <!-- nur für Admin sichtbar -->
                    <h:panelGroup>
                        <h:outputText value="Ja" rendered="#{e.approved}"/>
                        <p:commandButton id="btnApprove"
                                         value="Freigabe"
                                         icon="pi pi-check"
                                         styleClass="ui-button-sm"
                                         action="#{emissionsAdminBean.approve(e)}"
                                         update=":adminForm:dataTable :adminForm:messages"
                                         rendered="#{!e.approved}"/>
                    </h:panelGroup>
                </p:column>

                <p:column headerText="Aktionen" style="width:10%" rendered="#{facesContext.externalContext.isUserInRole('admin')}">
                    <p:commandButton icon="pi pi-trash"
                                     title="Datensatz löschen"
                                     action="#{emissionsAdminBean.delete(e)}"
                                     update=":adminForm:dataTable :adminForm:messages"
                                     oncomplete="PF('confirmDlg').hide()">
                        <p:confirm header="Bitte bestätigen" 
                                   message="Wollen Sie Datensatz #{e.id} wirklich löschen?"
                                   icon="pi pi-exclamation-triangle"/>
                    </p:commandButton>
                </p:column>

                <p:column headerText="Change-Log" style="width:30%" rendered="#{facesContext.externalContext.isUserInRole('admin')}">
                    <h:outputText value="#{e.changeLog}"/>
                </p:column>

                <!-- Ajax-Listener für Cell-Edit -->
                <p:ajax event="cellEdit"
                        listener="#{emissionsAdminBean.onCellEdit}"
                        update=":adminForm:dataTable :adminForm:messages"/>
            </p:dataTable>
        </h:form>

        <p:dialog id="dlgNewEmission"
                  header="Neue Emission anlegen"
                  widgetVar="dlgNewEmission"
                  modal="true" closable="true" resizable="false">

            <!-- neues Formular nur für den Dialog -->
            <h:form id="newEmissionForm">
                <p:messages id="newEmissionMessages"
                            showDetail="true"
                            showSummary="false"
                            style="margin-bottom:1em"/>

                <h:panelGrid columns="2" cellpadding="5">

                    <h:outputLabel for="countrySelect" value="Land:"/>

                    <p:selectOneMenu id="countrySelect"
                                     value="#{emissionsAdminBean.selectedCountryCode}"
                                     required="true" 
                                     requiredMessage="Bitte wählen Sie ein Land aus."
                                     style="width:100%">

                        <f:selectItem itemLabel="Bitte wählen ..." 
                                      itemValue="" 
                                      noSelectionOption="true"/>

                        <f:selectItems value="#{emissionsAdminBean.availableCountries}"
                                       var="c"
                                       itemLabel="#{c.country} (#{c.countryCode})"
                                       itemValue="#{c.countryCode}"/>

                        <p:ajax event="valueChange"
                                listener="#{emissionsAdminBean.onCountryCodeChange}"
                                process="@form"
                                update="newEmissionForm:newEmissionMessages
                                :adminForm:dataTable :adminForm:messages"/>                       
                    </p:selectOneMenu>

                    <h:outputLabel for="inYear" value="Jahr:"/>
                    <p:inputText id="inYear"
                                 value="#{emissionsAdminBean.newEmission.year}"
                                 required="true"
                                 maxlength="4" label="Jahr"/>

                    <h:outputLabel for="inCo2" value="CO₂ (kt):"/>
                    <p:inputText id="inCo2"
                                 value="#{emissionsAdminBean.newEmission.co2Emissions}"
                                 label="CO₂"/>
                </h:panelGrid>
                <p:commandButton value="Speichern"
                                 icon="pi pi-save"
                                 styleClass="ui-button-primary"
                                 process="@form"
                                 action="#{emissionsAdminBean.saveNew}"
                                 update="newEmissionForm:newEmissionMessages 
                                 :adminForm:dataTable 
                                 :adminForm:messages"              
                                 oncomplete="PF('dlgNewEmission').hide()"/>
            </h:form>
        </p:dialog>

        <h:panelGroup layout="block"
                      style="text-align:center; padding:0.5em; background:#f7f2e8">
            <h:outputText value="Modul: IPWA02-01 Programmierung von industriellen Informationssystemen mit Java EE"
                          style="font-weight:bold"/>
        </h:panelGroup>
        
        <p:confirmDialog global="true" widgetVar="confirmDlg" showEffect="fade">
            <p:commandButton value="Ja" type="button" styleClass="ui-confirmdialog-yes"/>
            <p:commandButton value="Nein" type="button" styleClass="ui-confirmdialog-no"/>
        </p:confirmDialog>
    </h:body>
</html>
